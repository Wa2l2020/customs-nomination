# دليل النظام - نظام الترشيح والتميز (Customs Nomination System)

هذا المستند يوفر شرحاً تفصيلياً لنظام الترشيح، بما في ذلك تسلسل الأحداث، الخصائص التقنية، وهيكلية قاعدة البيانات.

---

## 1. نظرة عامة (Overview)
نظام الترشيح والتميز هو منصة إلكترونية تهدف إلى أتمتة عملية ترشيح موظفي مصلحة الجمارك للجوائز المختلفة (مثل: الموظف المثالي، السائق المثالي، إلخ). يتيح النظام للموظفين تقديم ترشيحاتهم، وللمدراء اعتمادها، وللجنة التحكيم تقييمها وإعلان الفائزين.

---

## 2. تسلسل الأحداث (Workflow & Sequence of Events)

تتم عملية الترشيح عبر عدة مراحل متسلسلة لضمان الدقة والشفافية:

### المرحلة الأولى: التسجيل (Registration)
1.  يقوم الموظف أو المدير بإنشاء حساب جديد.
2.  يختار نوع التسجيل:
    *   **مدير عام (General Manager):** يسجل تحت إدارة مركزية معينة.
    *   **رئيس إدارة مركزية (Central Head):** يسجل كمسؤول عن قطاع كامل.
    *   **عضو لجنة (Committee):** يسجل باستخدام "كود سري" خاص.
3.  يتم إرسال بريد إلكتروني ترحيبي للمستخدم الجديد.

### المرحلة الثانية: تقديم الترشيح (Nomination Submission)
1.  يقوم "منسق الترشيح" (User) بالدخول للنظام.
2.  يملأ استمارة الترشيح التي تشمل:
    *   بيانات المرشح (الاسم، الوظيفة، الإدارة).
    *   فئة الجائزة (يتم تحميل الأسئلة ديناميكياً بناءً على الفئة).
    *   الإجابة على الأسئلة المقالية.
    *   رفع المرفقات (بيان حالة، أدلة) باستخدام تقنية **FilePond** (مع ضغط الصور وتأمين الملفات).
3.  عند الإرسال، يتم حفظ الترشيح بحالة `pending` (قيد الانتظار) وإرسال بريد تأكيد.

### المرحلة الثالثة: الاعتماد (Approval Cycle)
1.  **اعتماد المدير العام:**
    *   يظهر الترشيح في لوحة تحكم "المدير العام" التابع له المرشح.
    *   يقوم المدير بمراجعة البيانات والمرفقات.
    *   القرار: `approved_general` (مقبول مبدئياً) أو `rejected` (مرفوض).
2.  **اعتماد رئيس الإدارة المركزية:**
    *   الترشيحات المقبولة من المدير العام تظهر لـ "رئيس الإدارة المركزية".
    *   القرار: `approved_central` (مقبول نهائياً للتحكيم) أو `rejected`.

### المرحلة الرابعة: التحكيم (Evaluation)
1.  تظهر الترشيحات المعتمدة (approved_central) لأعضاء اللجنة (`committee`).
2.  يقوم كل عضو بتقييم الترشيح ووضع درجة (Score).
3.  يتم حساب متوسط الدرجات لتحديد الترتيب.

### المرحلة الخامسة: إعلان النتائج (Results)
1.  يقوم "رئيس المصلحة" (`chairman`) أو الأدمن بمراجعة الترتيب النهائي.
2.  تحويل حالة الفائزين إلى `winner`.
3.  يمكن تصدير النتائج والبيانات كملفات Excel أو PDF.

---

## 3. مميزات وخصائص النظام (System Features)

### أ. إدارة المرفقات الذكية (Smart Attachments)
*   **FilePond Integration:** واجهة رفع حديثة تدعم السحب والإفلات.
*   **Client-side Compression:** يتم ضغط الصور (JPG/PNG) على جهاز المستخدم قبل الرفع لتوفير المساحة (Resize to 1200px, Quality 80%).
*   **Secure Viewing:** الملفات محمية ولا يمكن الوصول إليها برابط مباشر. يتم عرضها عبر مسار آمن (`/admin/attachments/view/...`) يفتح في نافذة جديدة.

### ب. الإعدادات الديناميكية (Dynamic Settings)
*   يمكن للأدمن التحكم في إعدادات النظام من لوحة التحكم دون تعديل الكود:
    *   **المواعيد:** تحديد تواريخ انتهاء التسجيل، الترشيح، والاعتمادات.
    *   **البريد:** إعدادات SMTP (Host, Port, User, Pass).
    *   **التخزين:** التبديل بين التخزين المحلي (Local) والسحابي (Google Drive, OneDrive, Dropbox).

### ج. النسخ الاحتياطي والاستعادة (Backup & Restore)
*   **تصدير:** إمكانية تحميل قاعدة البيانات كاملة (SQL) أو أرشيف المرفقات (ZIP).
*   **استعادة:** إمكانية استرجاع النظام لحالة سابقة، مع خيار "تصفير النظام" (Reset) لبدء دورة جديدة مع الاحتفاظ بحسابات الأدمن الأساسية.

---

## 4. هيكلية قاعدة البيانات (Database Schema)

### 1. جدول المستخدمين (`users`)
يخزن بيانات الدخول والصلاحيات.
*   `id`: المعرف الفريد.
*   `name`, `email`, `password`: بيانات الدخول.
*   `role`: الصلاحية (`admin`, `general`, `central`, `committee`, `chairman`).
*   `department_id`: ربط المدير بإدارته (Foreign Key -> departments).
*   `plain_password`: (اختياري) لتسهيل الدعم الفني في البيئات المغلقة.
*   `last_login_at`: تاريخ آخر دخول.

### 2. جدول الإدارات (`departments`)
يمثل الهيكل التنظيمي الهرمي.
*   `id`: المعرف.
*   `name`: اسم الإدارة.
*   `parent_id`: الإدارة الأب (إذا كانت `NULL` فهي إدارة مركزية، وإذا لها قيمة فهي إدارة عامة تابعة).
*   `location`: الموقع الجغرافي.

### 3. جدول الترشيحات (`nominations`)
الجدول الأساسي الذي يربط كل شيء.
*   `id`: المعرف.
*   `user_id`: من قام بالترشيح (اختياري).
*   `employee_name`, `job_number`: بيانات المرشح.
*   `central_dept_id`, `general_dept_id`: التبعية الإدارية.
*   `category`: فئة الجائزة (مثل: مدير عام، موظف مثالي).
*   `status`: حالة الطلب (`pending`, `approved_general`, `approved_central`, `winner`, `rejected`).
*   `answers`: (JSON) يحتوي على إجابات الأسئلة المقالية.
*   `attachments`: (JSON) مصفوفة بمسارات الملفات المرفقة.
*   `cloud_folder_link`: رابط مجلد خارجي (اختياري).

### 4. جدول الإعدادات (`settings`)
تخزين إعدادات النظام (Key-Value Store).
*   `key`: اسم الإعداد (مثل `nomination_deadline`, `mail_host`).
*   `value`: القيمة.

### 5. جدول التقييمات (`evaluations`)
درجات اللجنة.
*   `id`: المعرف.
*   `nomination_id`: الترشيح المقيم.
*   `user_id`: عضو اللجنة المقيم.
*   `score`: الدرجة.
*   `comments`: ملاحظات.

### 6. جدول سجل النشاط (`activity_logs`)
لتتبع حركات المستخدمين (Audit Trail).
*   `user_id`: المستخدم.
*   `action`: نوع الحركة (login, submit, approve).
*   `description`: تفاصيل.
*   `ip_address`: عنوان IP.

---

## 5. دليل الأدوار (Roles Guide)

| الدور (Role) | الوصف والصلاحيات |
| :--- | :--- |
| **Admin** | تحكم كامل في النظام، الإعدادات، المستخدمين، والنسخ الاحتياطي. لا يتدخل في مسار التحكيم. |
| **General Manager** | مدير عام. يرى فقط الترشيحات التابعة لإدارته العامة. صلاحيته: اعتماد أولي أو رفض. |
| **Central Head** | رئيس إدارة مركزية. يرى الترشيحات المعتمدة من مدراء العموم التابعين له. صلاحيته: اعتماد نهائي للجنة. |
| **Committee** | عضو لجنة تحكيم. يرى جميع الترشيحات المعتمدة مركزياً. صلاحيته: وضع درجات وتقييم. |
| **Chairman** | رئيس المصلحة. يرى النتائج النهائية والداشبورد الشاملة. صلاحيته: اعتماد الفائزين. |

---

## 6. ملاحظات تقنية للمطورين
*   **المسارات (Routes):** جميع مسارات الأدمن تبدأ بـ `/admin` ومحمية بـ Middleware `auth` و `admin`.
*   **المرفقات:** تخزن في `storage/app/public/nominations/{job_number}`. يجب التأكد من وجود Symlink (`php artisan storage:link`).
*   **الواجهة:** مبنية باستخدام Blade Templates + Bootstrap 5.
*   **البريد:** يستخدم Laravel Queue (افتراضياً `sync` للتجربة) لإرسال الإشعارات.
